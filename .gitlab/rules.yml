# Rules for where jobs can run

###
## Job variables:
##   VTK_CI_RUN_MANUALLY
##     Set to "true" if the job should be manually triggered in MRs. These jobs
##     will also be delayed for branch update pipelines
####

# When to even consider running a pipeline.
workflow:
    rules:
        # Run for merge requests.
        - if: '$CI_MERGE_REQUEST_ID'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch/tag.
              on_new_commit: interruptible
        # If this is not a MR, do not run for other projects.
        - if: '$CI_PROJECT_PATH != "vtk/vtk"'
          when: never
        # Run for schedules.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: always
          auto_cancel:
              # Never cancel scheduled pipelines because of new commits.
              on_new_commit: none
        # Run for protected branches.
        - if: '$CI_COMMIT_REF_PROTECTED == "true"'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch.
              on_new_commit: interruptible
        # Run for tags.
        - if: '$CI_COMMIT_TAG'
          when: always
        # Skip pipelines in all other cases.
        - when: never

# Discover code changes
.changes: &code_change
    paths:
        # Ignore the documentation directory.
        - '!Documentation/**/*'
        - '**/*'
        - '.*'                # any hidden file is touched
        - '.*/**/*'           # any file within a hidden directory

.rules:
    rules:
        # MRs use manual triggers, but only if there are code chagens.
        - if: '$CI_MERGE_REQUEST_ID && $VTK_CI_RUN_MANUALLY == "true"'
          changes: *code_change
          when: manual
        # Normal jobs run automatically, but only if there are code changes.
        - if: '$CI_MERGE_REQUEST_ID'
          changes: *code_change
          when: on_success
        # Any other jobs on a MR do not run.
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        # Jobs on a tag run right away.
        - if: '$CI_COMMIT_TAG'
          when: on_success
        # Scheduled jobs run automatically.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: on_success
        # Manual jobs run delayed (e.g., merges to branches)
        - if: '$VTK_CI_RUN_MANUALLY == "true"'
          when: delayed
          start_in: 4 hours
        # Normal jobs on the project run automatically.
        - when: on_success

.scheduled_only:
    rules:
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        - if: '$CI_COMMIT_TAG'
          changes: *code_change
          when: on_success
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: on_success
        - when: never

.merged_only:
    rules:
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: on_success
        - when: delayed
          start_in: 4 hours
        - when: never

.release_only:
    rules:
      - if: '$CI_COMMIT_TAG'
        when: on_success
      - when: never

.upload_only:
    rules:
      - if: '$RSYNC_UPLOAD_ENABLE == "true"'
        when: on_success
      - when: never

.weekly_upload_only:
    rules:
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        - if: '$CI_COMMIT_TAG'
          when: on_success
        - if: '$PYPI_WEEKLY_UPLOAD == "true"'
          when: on_success
        - when: never

.tag_only:
    rules:
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        - if: '$CI_COMMIT_TAG'
          when: on_success
        - when: never
